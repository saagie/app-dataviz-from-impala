var app=angular.module("app",["nvd3","ui.bootstrap","RecursionHelper"]),pages=[];app.controller("main",["$scope","$modal",function(e,t){pages[0]={},pages[0].header=!1,pages[0].body="v",pages[0].footer=!1,pages[0].boxes=[],pages[0].boxes[0]={id:"0-0",type:"text",text:"<h1>Data Story Title</h1><p>Start your data story here.</p>",preview:!1},pages[0].boxes[1]={id:"0-1",type:"empty"},pages[1]={},pages[1].header=!1,pages[1].body="",pages[1].footer=!1,pages[1].boxes=[],pages[1].boxes[0]={id:"1-0",type:"empty"},e.page=pages[0],e.drilldown={},e.drilldown.activated=!1,e.drilldown.parent=[],e.pages=pages,e.rootPages=pages,e.pageindex=0,e.prevPage=function(){e.pageindex=e.pageindex-1,e.page=e.pages[e.pageindex]},e.nextPage=function(){e.pageindex=e.pageindex+1,e.page=e.pages[e.pageindex]},e.backToParent=function(){var t=e.drilldown.parent.splice(e.drilldown.parent.length-1,1);e.page=t[0].page,e.pages=t[0].pages,e.pageindex=t[0].pageindex,e.drilldown.parent.length<1&&(e.drilldown.activated=!1)},e.newPage=function(){t.open({templateUrl:"app/newpage.html",controller:"NewPageCtrl",size:"lg",resolve:{modalconfig:function(){var e={};return e}}})},e.share=function(){t.open({templateUrl:"app/share.html",controller:"ShareCtrl",size:"lg",resolve:{modalconfig:function(){var e={};return e}}})},e.showTree=function(t){e.tree=!0},e.$on("closeTree",function(){e.tree=!1}),e.edit=!1,e.$on("showEdit",function(t,a){e.edit=!0,e.currentbox=a}),e.$on("closeEdit",function(){e.edit=!1}),e.requestbuilder=!1,e.tree=!1,e.$on("showRequestBuilder",function(t,a){e.requestbuilder=!0,e.currentbox=a}),e.$on("closeRequestBuilder",function(){e.requestbuilder=!1}),e.$on("applyRequestBuilder",function(t,a){e.requestbuilder=!1,e.currentbox.chart=a.chart,e.currentbox.data=a.data,e.currentbox.dataFieldName=a.dataFieldName}),e.$on("addPage",function(t,a){e.pages.splice(e.pageindex+1,0,a),e.pageindex=e.pageindex+1,e.page=e.pages[e.pageindex]}),e.$on("gotoDrillDown",function(t,a){e.drilldown.activated=!0;var i={};i.page=e.page,i.pages=e.pages,i.pageindex=e.pageindex,e.drilldown.parent.push(i),e.pages=a.pages,e.page=a.pages[0],e.pageindex=0}),e.$on("addDrillDown",function(t,a,i){e.drilldown.activated=!0;var n={};n.page=e.page,n.pages=e.pages,n.pageindex=e.pageindex,e.drilldown.parent.push(n),void 0==i.pages?(i.pages=[],i.pages[0]=a,e.pageindex=0):(i.pages.splice(e.pageindex+1,0,a),e.pageindex=e.pageindex+1),e.pages=i.pages,e.page=e.pages[e.pageindex]})}]),app.directive("box",["$modal",function(e){return{templateUrl:"app/box.html",restrict:"E",scope:{box:"=",page:"="},link:function(t,a,i,n){t.edit=!1,t.switchPreviewText=function(e){if(e.preview=!e.preview,e.preview&&void 0!=e.data&&e.data.length>0){var t=e.text;angular.forEach(e.dataFieldName,function(a){t=t.replace(new RegExp("## "+a+" ##","g"),fieldNameConverter(e.data[0],a))}),e.rendered_text=t}else e.rendered_text=e.text},t.drillDown=function(a){void 0==a.pages||0==a.pages.length?e.open({templateUrl:"app/newpage.html",controller:"NewDrillDownCtrl",size:"lg",resolve:{modalconfig:function(){var e={box:a};return e}}}):t.$emit("gotoDrillDown",a)},t.changeChart=function(){t.edit=!0},t.changeBoxType=function(e,t){t.type=e,"text"==e&&(t.text="Change text here",t.preview=!1),"image"==e&&(t.imgurl="assets/report.jpg"),(e="chart")&&(t.chart={},t.chart.type="discreteBarChart",t.chart.chart_options={chart:{type:"discreteBarChart",height:450,margin:{top:20,right:20,bottom:60,left:55},x:function(e){return e.label},y:function(e){return e.value},showValues:!0,valueFormat:function(e){return d3.format(",.4f")(e)},transitionDuration:500,xAxis:{axisLabel:"X Axis"},yAxis:{axisLabel:"Y Axis",axisLabelDistance:30}}},t.chart.chart_config={visible:!0,extended:!1,disabled:!1,autorefresh:!0,refreshDataOnly:!1},t.data=[{label:"A",value:29.765957771107},{label:"B",value:2},{label:"C",value:32.807804682612},{label:"D",value:196.45946739256},{label:"E",value:.19434030906893}],t.dataFieldName=fillFieldName(t.data),convertDataToDataChart(t.data,t.dataFieldName,t.chart,t.chart.type))},t.edit=function(e){t.$emit("showEdit",e)}}}}]),app.directive("contenteditable",function(){return{restrict:"A",require:"ngModel",link:function(e,t,a,i){function n(){i.$setViewValue(t.html())}i.$render=function(){t.html(i.$viewValue||"")},t.bind("blur keyup change",function(){e.$apply(n)})}}}),app.directive("edit",function(){return{templateUrl:"app/edit.html",restrict:"E",scope:{box:"="},link:function(e,t,a,i){e.menu="options",e.buildRequest=function(t){e.$emit("showRequestBuilder",t)},e.close=function(){e.$emit("closeEdit")},e.charts=[],e.charts[0]={name:"Discrete Bar Chart",key:"discreteBarChart"},e.charts[1]={name:"Donut Chart",key:"donutChart"},e.changeChartType=function(e,t){t.chart.type=e,"donutChart"==e&&(t.chart.chart_options={chart:{type:"pieChart",height:450,donut:!0,x:function(e){return e.key},y:function(e){return e.y},showLabels:!0,pie:{startAngle:function(e){return e.startAngle/2-Math.PI/2},endAngle:function(e){return e.endAngle/2-Math.PI/2}},transitionDuration:500,legend:{margin:{top:5,right:70,bottom:5,left:0}}}}),"discreteBarChart"==e&&(t.chart.chart_options={chart:{type:"discreteBarChart",height:450,margin:{top:20,right:20,bottom:60,left:55},x:function(e){return e.label},y:function(e){return e.value},showValues:!0,valueFormat:function(e){return d3.format(",.4f")(e)},transitionDuration:500,xAxis:{axisLabel:"X Axis"},yAxis:{axisLabel:"Y Axis",axisLabelDistance:30}}}),t.dataFieldName=fillFieldName(t.data),convertDataToDataChart(t.data,t.dataFieldName,t.chart,t.chart.type)}}}}),app.directive("requestbuilder",["$http","$filter",function($http,$filter){return{templateUrl:"app/requestbuilder.html",restrict:"E",scope:{box:"="},link:function(scope,element,attrs,controllers){scope.menu="raw",scope.data=[],scope.dataFieldName=[],scope.limit_col=3,scope.limit_line=10;var type="";"chart"==scope.box.type&&(scope.chart={},scope.chart.chart_options=scope.box.chart.chart_options,scope.chart.chart_config=scope.box.chart.chart_config,scope.chart.chart_data=scope.box.chart.chart_data,scope.chart.type=scope.box.chart.type,type=scope.box.chart.type),scope.data=scope.box.data,scope.dataFieldName=scope.box.dataFieldName,"text"==scope.box.type&&(scope.limit_line=1),scope.close=function(){scope.$emit("closeRequestBuilder")},scope.apply=function(){var e={};e.data=scope.data,e.dataFieldName=scope.dataFieldName,e.chart=scope.chart,scope.$emit("applyRequestBuilder",e)},scope.request="SELECT * FROM promo",scope.query=function(request){var body={};body.request=request,$http.post("/api/v1/data/impala/query",body).success(function(data){scope.dataFieldName=[],scope.data=eval(data.data),scope.dataFieldName=fillFieldName(scope.data),"chart"==scope.box.type&&refreshGraph()}).error(function(e){console.log("Error")})},scope.reloadSchema=function(){$http.get("/api/v1/data/impala/schema").success(function(e){scope.schema=e}).error(function(e){console.log("Error")})};var refreshGraph=function(){convertDataToDataChart(scope.data,scope.dataFieldName,scope.chart,type)}}}}]);var fillFieldName=function(e){var t=[];return angular.forEach(Object.keys(e[0]),function(e){t.push(e)}),t},convertDataToDataChart=function(e,t,a,i){a.chart_data=[],"discreteBarChart"==i&&a.chart_data.push({key:"label",values:[]}),angular.forEach(e,function(e){var n={};angular.forEach(t,function(t,a){var o=fieldNameConverter(e,t);"discreteBarChart"==i&&(0==a&&(n.label=o),1==a&&(n.value=o)),"donutChart"==i&&(0==a&&(n.key=o),1==a&&(n.y=o))}),"discreteBarChart"==i&&a.chart_data[0].values.push(n),"donutChart"==i&&a.chart_data.push(n)})};app.directive("page",function(){return{templateUrl:"app/page.html",restrict:"E",scope:{page:"=",currentbox:"="},link:function(e,t,a,i){}}}),app.directive("variables",function(){return{templateUrl:"app/variables.html",restrict:"E",scope:{datafieldname:"=",data:"="},link:function(e,t,a,i){}}}),app.directive("tree",["RecursionHelper",function(e){return{templateUrl:"app/tree.html",restrict:"E",scope:{pages:"=",currentpage:"=",first:"="},compile:function(t){return e.compile(t,function(e,t,a,i,n){e.close=function(){e.$emit("closeTree")}})}}}]),app.controller("NewDrillDownCtrl",["$scope","$rootScope","$modalInstance","modalconfig",function(e,t,a,i){e.addPage=function(e){var n=createPage(e,pages);t.$broadcast("addDrillDown",n,i.box),a.dismiss()}}]),app.controller("NewPageCtrl",["$scope","$rootScope","$modalInstance","modalconfig",function(e,t,a,i){e.addPage=function(e){var i=createPage(e,pages);t.$broadcast("addPage",i),a.dismiss()}}]),app.controller("ShareCtrl",["$scope","$rootScope","$modalInstance","modalconfig",function(e,t,a,i){}]);var createPage=function(e,t){var a={},n=1,o="";for("split2v"==e.body&&(n=2,o="v"),"split2h"==e.body&&(n=2,o="h"),"split3v"==e.body&&(n=3,o="v"),"split4"==e.body&&(n=4,o=""),"split6"==e.body&&(n=6,o=""),"split8"==e.body&&(n=8,o=""),a.body=o,a.header=e.header,a.footer=e.footer,a.boxes=[],i=0;i<n;i++){var l=t.length+"-"+i;a.boxes[i]={id:l,type:"empty"}}return a};app.filter("sumArray",function(){return function(e,t){var a=0;return angular.forEach(e,function(e){a+=Number(e[t])}),a}});var fieldNameConverter=function(e,t){return e[t]};app.filter("fieldName",function(){return function(e,t){return fieldNameConverter(e,t)}}),angular.module("webapp").run(["$templateCache",function(e){e.put("app/box.html",'<div><button ng-if="box.type != \'empty\' && box.type != undefined" class="btn glyphicon glyphicon-remove btn-close" ng-click="changeBoxType(\'empty\',box)"></button> <button ng-if="box.type == \'chart\' || box.type == \'table\' || box.type == \'text\'" class="btn glyphicon glyphicon-pencil btn-edit" ng-click="edit(box)">Edit</button> <button ng-if="box.type != \'empty\' && box.type != undefined" class="btn glyphicon glyphicon-search btn-drilldown" ng-click="drillDown(box)">Add a Drill Down</button> <button ng-if="box.type == \'text\' && box.preview" class="btn btn-txt-mode glyphicon glyphicon-eye-open" ng-click="switchPreviewText(box)">Preview text mode</button> <button ng-if="box.type == \'text\' && !box.preview" class="btn btn-txt-mode glyphicon glyphicon-eye-close" ng-click="switchPreviewText(box)">Edit text mode</button><div ng-if="box.type == \'text\' && box.preview == false" contenteditable="" ng-model="box.text" strip-br="true" select-non-editable="true"></div><div ng-if="box.type == \'text\' && box.preview" contenteditable="false" ng-model="box.rendered_text" strip-br="true"></div><div ng-if="box.type == \'empty\' || box.type == undefined"><button class="btn glyphicon glyphicon-font" ng-click="changeBoxType(\'text\',box)">Text</button> <button class="btn glyphicon glyphicon-picture" ng-click="changeBoxType(\'image\',box)">Image</button> <button class="btn glyphicon glyphicon glyphicon-stats" ng-click="changeBoxType(\'chart\',box)">Graph</button> <button class="btn glyphicon glyphicon-th-list" ng-click="changeBoxType(\'table\',box)">Dynamic Table</button></div><div ng-if="box.type == \'image\'"><img src="{{box.imgurl}}"></div><div ng-if="box.type == \'chart\'"><nvd3 options="box.chart.chart_options" data="box.chart.chart_data" config="box.chart.chart_config"></nvd3></div><div ng-if="box.type == \'table\'"><table class="table table-striped"><tr><th ng-repeat="name in box.dataFieldName">{{ name }} <span ng-if="$index==0 && box.type==\'chart\'">(label)</span> <span ng-if="$index==1 && box.type==\'chart\'">(value)</span> <span ng-if="$index==2 && box.type==\'chart\'">(id)</span></th></tr><tr ng-repeat="item in box.data" ng-if="$index"><td ng-repeat="name in box.dataFieldName">{{ item | fieldName : name }}</td></tr><tr class="active"><td>Total</td><td class="text-right">{{ box.data | sumArray : box.dataFieldName[1] | number : 2 }}</td></tr></table></div></div>'),e.put("app/edit.html",'<div><button class="btn glyphicon glyphicon-remove btn-close" ng-click="close()"></button><h2>Edit</h2><div ng-if="menu==\'options\'"><div ng-if="box.type == \'chart\'"><h3>1. Chart type</h3><select id="selectChart" ng-model="box.chart.type" ng-change="changeChartType(box.chart.type,box)" ng-options="chart.key as chart.name for chart in charts" class="form-control"></select><h3>2. Select data</h3><button class="btn btn-primary" ng-click="buildRequest(box)">Request Data</button><h3>3. Customize</h3><div ng-if="box.chart.type == \'discreteBarChart\'"><label>Extended</label><input type="checkbox" ng-model="box.chart.chart_config.extended" class="form-control"> <label>Transition Duration</label><input type="text" ng-model="box.chart.chart_options.chart.transitionDuration" class="form-control"> <label>X Axis Label</label><input type="text" ng-model="box.chart.chart_options.chart.xAxis.axisLabel" class="form-control"> <label>Y Axis Label</label><input type="text" ng-model="box.chart.chart_options.chart.yAxis.axisLabel" class="form-control"></div></div><div ng-if="box.type == \'table\'"><h3>1. select data</h3><button class="btn btn-primary" ng-click="buildRequest(box)">Request Data</button></div><div ng-if="box.type == \'text\'"><h3>1. select data</h3><button class="btn btn-primary" ng-click="buildRequest(box)">Request Data</button><h3>2. pick variables</h3><variables data="box.data" datafieldname="box.dataFieldName"></variables></div></div></div>'),e.put("app/newpage.html",'<div><div class="modal-header"><button type="button" class="close" ng-click="$dismiss()" aria-hidden="true">&times;</button><h4 class="modal-title">New Page</h4></div><div class="modal-body"><hr><div class="checkbox"><label><input type="checkbox" ng-model="newpage.header"> Include a header</label></div><hr><div class="row"><div class="col-md-3"><div class="radio"><label><input type="radio" ng-model="newpage.body" name="body" value="full"> <img src="assets/nodes/1.png" width="90"></label></div><div class="radio"><label><input type="radio" ng-model="newpage.body" name="body" value="split2v"> <img src="assets/nodes/2.png" width="90"></label></div></div><div class="col-md-3"><div class="radio"><label><input type="radio" ng-model="newpage.body" name="body" value="split2h"> <img src="assets/nodes/2h.png" width="90"></label></div><div class="radio"><label><input type="radio" ng-model="newpage.body" name="body" value="split3v"> <img src="assets/nodes/3.png" width="90"></label></div></div><div class="col-md-3"><div class="radio"><label><input type="radio" ng-model="newpage.body" name="body" value="split4"> <img src="assets/nodes/4.png" width="90"></label></div><div class="radio"><label><input type="radio" ng-model="newpage.body" name="body" value="split6"> <img src="assets/nodes/6.png" width="90"></label></div></div><div class="col-md-3"><div class="radio"><label><input type="radio" ng-model="newpage.body" name="body" value="split8"> <img src="assets/nodes/8.png" width="90"></label></div></div></div><hr><div class="checkbox"><label><input type="checkbox" ng-model="newpage.footer"> Include a Footer</label></div><button type="submit" class="btn btn-success" ng-click="addPage(newpage)">Add</button></div><div class="modal-footer"></div></div>'),e.put("app/page.html",'<div class="page"><div ng-if="page.header"><div class="header" contenteditable="" ng-model="page.header_text" strip-br="true" select-non-editable="true"></div></div><div ng-if="page.boxes.length<=3 && page.body!=\'h\'"><box class="box box-{{page.boxes.length}}{{page.body}} ng-class:{ \'box-selected\': box.id==currentbox.id };" ng-repeat="box in page.boxes" box="box" page="page"></box></div><div ng-if="page.boxes.length>3 && page.body!=\'h\'"><div class="box-line"><box class="box box-{{page.boxes.length}}{{page.body}} ng-class:{ \'box-selected\': box.id==currentbox.id };" ng-repeat="box in page.boxes" box="box" page="page" ng-if="$index < page.boxes.length/2"></box></div><div class="box-line"><box class="box box-{{page.boxes.length}}{{page.body}} ng-class:{ \'box-selected\': box.id==currentbox.id };" ng-repeat="box in page.boxes" box="box" page="page" ng-if="$index >= page.boxes.length/2"></box></div></div><div ng-if="page.body==\'h\'"><div class="box-line" ng-repeat="box in page.boxes"><box class="box box-{{page.boxes.length}}{{page.body}} ng-class:{ \'box-selected\': box.id==currentbox.id };" box="box" page="page"></box></div></div><div ng-if="page.footer"><div class="footer" contenteditable="" ng-model="page.footer_text" strip-br="true" select-non-editable="true"></div></div></div>'),e.put("app/requestbuilder.html",'<div><button class="btn glyphicon glyphicon-remove btn-danger pull-right btn-right" ng-click="close()">Cancel</button> <button class="btn glyphicon glyphicon-ok btn-success pull-right btn-right" ng-click="apply()">Apply</button><ul class="nav nav-pills"><li role="presentation" ng-class="[{active: menu == \'wizard\'}]" ng-click="menu=\'wizard\'"><a href="#">Wizard</a></li><li role="presentation" ng-class="[{active: menu == \'raw\'}]" ng-click="menu=\'raw\'"><a href="#">I\'m a boss, I know how to write SQL request</a></li></ul><div ng-if="menu==\'wizard\'"><div class="fakewizard">Here it is a fantastic wizard.</div></div><div ng-if="menu==\'raw\'"><div class="col-md-7"><textarea class="form-control" rows="4" ng-model="request"></textarea> <button class="btn btn-primary" ng-click="query(request)">Request</button></div><div class="col-md-5"><button class="btn btn-info pull-right" ng-click="reloadSchema()">Load Schema</button><div class="schema"><ul><li ng-repeat="db in schema.database">{{db.name}}<ul><li ng-repeat="tb in db.table">{{tb.name}}<ul><li ng-repeat="fd in tb.field">{{fd.name}} / {{fd.type}} / {{fd.comment}}</li></ul></li></ul></li></ul></div></div><div class="alert alert-info" ng-if="box.type == \'chart\'"><h4>Pick the right data</h4>For this type of dataviz, you are limited to 3 columns (label, value and id, id is optional).</div><div class="alert alert-info" ng-if="box.type == \'text\'"><h4>Pick the right data</h4>For this box type, you are limited to 1 line.</div><div class="row"><div class="col-md-6"><table class="table table-striped"><tr><th ng-repeat="name in dataFieldName">{{ name }} <span ng-if="$index==0 && box.type==\'chart\'">(label)</span> <span ng-if="$index==1 && box.type==\'chart\'">(value)</span> <span ng-if="$index==2 && box.type==\'chart\'">(id)</span></th></tr><tr ng-repeat="item in data" ng-if="$index < limit_line"><td ng-repeat="name in dataFieldName">{{ item | fieldName : name }}</td></tr></table></div><div class="col-md-6" ng-if="box.type == \'chart\'"><nvd3 options="chart.chart_options" data="chart.chart_data" config="chart.chart_config"></nvd3></div><div class="col-md-6" ng-if="box.type == \'text\'"><div class="col-md-6"><variables data="data" datafieldname="dataFieldName"></variables></div></div></div></div></div>'),e.put("app/share.html",'<div><div class="modal-header"><button type="button" class="close" ng-click="$dismiss()" aria-hidden="true">&times;</button><h4 class="modal-title">Share</h4></div><div class="modal-body"><input type="text" size="60" value="http://share.sagee.io/xtuindgfh"> <button type="submit" class="btn btn-info pull-right">Copy Link</button> <button type="submit" class="btn btn-success pull-right">Email Link</button></div><div class="modal-footer"></div></div>'),e.put("app/tree.html",'<div><div ng-if="first"><button class="btn glyphicon glyphicon-remove btn-close" ng-click="close()"></button><h2>Your presentation</h2></div><div ng-repeat="page in pages" class="tree"><div class="tree-page ng-class:{ \'tree-page-selected\': currentpage==page };"><span>{{ $index + 1 }}</span><br><img src="assets/nodes/1.png" ng-if="page.boxes.length == 1" class="ng-class:{ \'tree-small-box\': !first };"> <img src="assets/nodes/2.png" ng-if="page.boxes.length == 2 && page.body!=\'h\'" class="ng-class:{ \'tree-small-box\': !first };"> <img src="assets/nodes/2h.png" ng-if="page.boxes.length == 2 && page.body==\'h\'" class="ng-class:{ \'tree-small-box\': !first };"> <img src="assets/nodes/3.png" ng-if="page.boxes.length == 3" class="ng-class:{ \'tree-small-box\': !first };"> <img src="assets/nodes/4.png" ng-if="page.boxes.length == 4" class="ng-class:{ \'tree-small-box\': !first };"> <img src="assets/nodes/6.png" ng-if="page.boxes.length == 6" class="ng-class:{ \'tree-small-box\': !first };"> <img src="assets/nodes/8.png" ng-if="page.boxes.length == 8" class="ng-class:{ \'tree-small-box\': !first };"></div><div ng-repeat="box in page.boxes"><tree ng-if="box.pages.length>0" pages="box.pages" currentpage="currentpage" first="false"></tree></div></div></div>'),e.put("app/variables.html",'<table class="table table-striped"><tr><th>Variable</th><th>Value</th></tr><tr ng-repeat="name in datafieldname"><td>## {{ name }} ##</td><td>{{ data[0] | fieldName : name }}</td></tr></table>')}]);